FMRIPrep: a robust preprocessing pipeline for functional MRI

功能性磁共振成像（fMRI）的预处理包括众多步骤，以在统计分析前清理和标准化数据。通常，研究人员会针对每一个新数据集临时设计预处理流程，并且在每一步都依赖大量可用工具。随着MR数据采集和图像处理技术的快速发展，这些预处理流程的复杂性也不断增加。我们在此介绍fMRIPrep，一款分析方法无关的工具，专门应对任务型和静息状态fMRI数据在稳健和可复现预处理方面的挑战。fMRIPrep能够根据几乎任何数据集的独特特性自动调整最优的预处理流程，确保高质量的预处理，无需人工干预。通过在软件测试的迭代整合框架中引入可视化评估检查点，我们展示fMRIPrep能够在OpenfMRI数据库中涵盖54项不同研究的多样化fMRI数据集上稳健地产生高质量结果。我们在与其他预处理流程的定性比较中回顾了fMRIPrep的独特特性。我们证明fMRIPrep的空间精度更高，因为它比常用预处理工具引入更少不可控的空间平滑。fMRIPrep有潜力变革fMRI研究，为神经科学家提供高质量、稳健、易用且透明的预处理工作流程，有助于确保推断结果的有效性和结果的可解释性。

功能性磁共振成像（fMRI）是一种常用的技术，用于绘制人类大脑活动图谱¹。然而，fMRI测量到的血氧水平依赖（BOLD）信号通常会与许多非神经源的变化因素混杂在一起²。预处理的目的在于识别这些干扰源并减少它们对数据的影响³。其他主要的预处理步骤⁴则针对特定的成像伪影和信号的解剖定位。例如，切片时间⁵校正（STC）、头部运动校正（HMC）和磁敏感畸变校正（SDC）分别用于处理不同类型的伪影；而共配准和空间标准化则与信号的位置相关（详见在线方法部分中的“fMRI预处理要点”总结）。提取最忠实于底层神经活动的信号，对于保证推断的有效性和结果的可解释性至关重要⁶。如果预处理有误，可能会导致将噪声模式误解为感兴趣的信号。例如，Power等人指出，在静息态fMRI中未考虑头部运动可能会产生虚假且系统性的相关性⁷，这些相关性可能被误解为功能连接。空间标准化失败的一个常见例子，就是研究人员发现大脑外部有显著激活现象。其他预处理选择可能导致源自脑活动的信号被移除。关于是否需要回归全局信号的持续争论²,⁸,⁹，正体现了这种担忧。因此，预处理的一个主要目标是减少第一类错误（假阳性）的来源，同时避免过度引发第二类错误（假阴性）。

fMRI预处理流程通常产生两类主要输出：一类是经过预处理的数据（区别于原始、未处理的数据），另一类是用于后续建模的实验混杂因素的测量值。预处理后的数据通常包括应用了回顾性信号校正和滤波算法后得到的新fMRI时间序列。此外，这些数据还通常会被重采样到适合分析的目标空间，如标准化的解剖参考空间。混杂因素则是一些额外的时间序列，包括生理记录和估算的噪声源，它们在分析过程中很有用（例如，可以作为干扰回归项）。一些常用的混杂因素包括：运动参数、逐帧位移（FD⁷）、在时间差分后数据的空间标准差（DVARS⁷）、全局信号等。预处理过程中还可能包含进一步的去噪和混杂因素估算步骤。例如，基于主成分分析（PCA）或独立成分分析（ICA）的降维方法，如基于成分的噪声校正（CompCor¹⁰）或自动去除运动伪影（ICA-AROMA¹¹）等。

神经影像学领域已经配备了大量工具，可以实现前述大部分预处理的具体步骤。这些工具在诸如AFNI¹²、ANTs¹³、FreeSurfer¹⁴、FSL¹⁵、Nilearn¹⁶或SPM¹⁷等软件包中都可以轻松获取。尽管业界已有广泛可用的软件，以及关于预处理最佳实践的多次尝试和指导²,⁴,⁶,¹⁸，不同的数据采集方案的多样性却导致几乎每项研究都采用了临时定制的流程。例如，Carp¹⁹在241项fMRI研究中发现了223种独特的数据分析流程。因此，目前的预处理流程往往在结果质量和在特定数据集之外的稳健性与一致性之间存在明显的妥协。另一个选择是，研究者可以采用由大型神经影像协会（如人类连接组计划HCP²⁰或英国生物库UK Biobank²¹）定义的数据采集协议，从而使用专为这些研究开发的预处理流程²²,²³。然而，这些流程针对特定采集协议进行了优化，并不适用于采用不同采集协议获得的数据集。现实中，神经影像学领域仍然缺乏一种能够可靠地为任意数据集提供高质量、一致性结果的预处理工作流。

在这里我们介绍fMRIPrep，这是一套用于任务型和静息态fMRI的预处理工作流。fMRIPrep基于四项核心原则构建：1）能够适应输入数据集的各种特殊性，具备高度稳健性；2）预处理结果的高质量；3）流程透明，鼓励对预处理结果进行质量审查，并促进方法的准确交流；4）易于使用，尽量减少人工干预。fMRIPrep的稳健性源自其灵活且自适应的架构，能够结合现有神经影像分析工具包中的不同工具。针对每一个处理步骤，所选工具都是通过循证和社区参与的优化流程确定的。本文同时报告了该工作流在OpenfMRI数据库中大规模且异质性强的子样本上的全面评估，用以量化结果的稳健性和质量。这项评估充分利用了fMRIPrep生成的可视化报告，这些报告有助于结果的评估和整理。这些报告也体现了fMRIPrep所倡导的“玻璃盒”开发理念——不是将复杂的操作封装在一个不透明的黑盒中，而是在多个步骤公开中间结果，鼓励科研人员积极参与和监督整个流程。

## 结果

FMRIPrep是一款稳健且方便的工具，能够帮助研究人员和临床工作者对任务型和静息态fMRI数据进行分析前的预处理。它的输出结果可以支持多种应用，包括使用功能定位器的受试者内分析、体素为单位的分析、基于皮层表面的分析、任务型的群体分析、静息态连通性分析以及其他多种用途。下文将介绍该工具的整体架构、软件工程原则以及全面的验证过程。

**图像1的解释：**

Copilot said: 这张图展示了**fMRIPrep**（一种fMRI预处理工具）对输入数据的预处理流程，分为**解剖预处理（左侧蓝色部分）**和**功能预处理（右侧黄色部分）**两个主要环节。以下是详细解释： --- ### 1. 输入数据类型 - **T1-weighted（T1加权）**：一组或多组T1加权结构像（主要输入，左上角）。 - **T2-weighted（T2加权）**：可选的结构像（左上角旁）。 - **BOLD run**：血氧水平依赖（BOLD）序列，即fMRI的功能数据（右上角）。 --- ###
这张图展示了fMRIPrep（一种fMRI预处理工具）对输入数据的预处理流程，分为**解剖预处理（左侧蓝色部分）和功能预处理（右侧黄色部分）**两个主要环节。以下是详细解释：

1. 输入数据类型
T1-weighted（T1加权）：一组或多组T1加权结构像（主要输入，左上角）。
T2-weighted（T2加权）：可选的结构像（左上角旁）。
BOLD run：血氧水平依赖（BOLD）序列，即fMRI的功能数据（右上角）。
2. 解剖预处理流程（左侧蓝色）
INU Correction：估算并校正非均匀性（Intensity Nonuniformity, INU）。让结构像的亮度更一致。
Fuse & Conform：将所有T1像进行配准并平均，生成三维参考图像。
Skull-stripping：用图谱方法分离脑组织和头骨，得到无头骨的脑图像。
Spatial normalization：把个体脑图像非线性配准到标准模板（MNI空间），便于群体比较。
Brain tissue segmentation：对脑组织进行体素级分类，区分灰质、白质等。
Surface reconstruction：重建皮层内外表面，为后续表面分析做准备。
3. 功能预处理流程（右侧黄色）
Generate reference & brain mask：对BOLD序列做特定平均，并分离出脑区。
Estimation of head-motion：计算每个时间点的头部运动参数，减少因头动带来的影响。
Slice-timing correction（可选）：校正切片采集时差，让所有切片仿佛在同一时刻采集。
Susceptibility distortion estimation（可选）：估算并校正BOLD信号的磁敏畸变。
4. 数据匹配与输出
Alignment to T1w reference：将功能数据配准到结构（T1加权）空间，实现空间对齐。
Preprocessed outputs：
Preprocessed (surface)：BOLD序列在皮层表面上的重采样结果；
Preprocessed (other)：BOLD序列在其他空间（如标准空间）的重采样结果；
Preprocessed (native)：功能数据在原始空间的结果。
Confounds：计算并输出各类干扰参数（如头动参数、全局信号等），用于后续统计分析校正。
总结说明
这张图强调了fMRIPrep的自动适应输入数据特点，不需要手动干预即可完成复杂的预处理，保证数据质量并为后续分析做好充分准备。
下方说明提到其高度合规和易于导航的输出，支持多种空间和批量数据的处理。

模块化设计实现了灵活、自适应的工作流程
fMRIPrep的基础如图1所示。该工作流程由若干子流程组成，这些子流程会根据输入数据动态组合成不同的配置。这些构建模块集成了众多业界常用的开源神经影像工具（详见表1汇总）。Nipype²⁵被用于组织工作流程，并负责执行细节（如资源管理）。如图1所示，整个流程分为两个主要环节，分别对应解剖MRI和功能MRI的处理流程。

自动理解输入数据。脑影像数据结构（BIDS²⁴）使得fMRIPrep能够精确识别输入数据的结构，并收集全部可用元数据（如成像参数）。详见在线方法部分的“BIDS生态系统介绍”，说明BIDS如何赋予工作流程灵活性。fMRIPrep可以通过一套启发式方法可靠地应对数据集的各种不规范情况，例如缺失的采集或扫描。例如，如果某个样本中只有一个参与者缺少场映射数据，fMRIPrep就会针对这个参与者跳过相关校正步骤。

**表格1的解释：**

表格分为三列：

1. Preprocessing task（预处理任务）
列出了进行fMRI数据预处理时常见的各项流程，比如：

结构像脑提取（Anatomical T1w brain-extraction）
表面重建（Anatomical surface reconstruction）
头动估算与校正（Head-motion estimation and correction）
磁敏感畸变校正（Susceptibility-derived distortion estimation and unwarping）
切片时间校正（Slice-timing correction）
受试者内配准（Intra-subject registration）
空间标准化（Spatial normalization）
表面采样（Surface sampling）
去噪（Subspace projection denoising，比如ICA、PCA等）
混杂因素（Confounds）
非稳态检测（Detection of nonsteady-states）
2. fMRIPrep includes（fMRIPrep所集成的工具）
这一列对应每项任务说明fMRIPrep本身用到的是哪些主流开源神经影像工具和算法。例如：

T1脑提取用的是ANTS工具的antsBrainExtraction.sh
表面重建用的是FreeSurfer的recon-all
头动估算用的是FSL的mcflirt
畸变校正用的是AFNI的3dQwarp
切片时间校正用的是AFNI的3dTshift
受试者内配准用的是FreeSurfer的bbregister和FSL的flirt
等等
3. Alternatives（替代工具，fMRIPrep未集成）
这一列列出了其他常用但未被fMRIPrep集成的可选同类工具。例如：

FSL中的bet做T1脑提取，AFNI的3dSkullstrip，SPM扩展工具的MRTOOL
CIVET、BrainSuite等用于解剖表面重建
AFNI的3dvolreg、SPM的spm_realign等用于头动估算
FSL的fugue、topup和FieldMap、HySCO等用于畸变校正
FSL的splicetimer、SPM的spm_slice_timing等用于切片时间校正
SPM、AFNI、FSL等其他软件的相关配准和标准化功能
其他表面和去噪相关工具，各种confounds和非稳态检测的方法
总结
这个表格的目的是让读者了解fMRIPrep集成的是业内哪些最主流和高质量的预处理工具，并展示针对每种预处理流程，用户还有哪些替代选项可以用，体现了fMRIPrep的“最佳工具集成”理念，以及其模块化设计和高度的兼容性。

解剖图像的预处理。T1加权（T1w）图像首先使用N4BiasFieldCorrection（ANTs）进行强度非均匀性（INU）校正，然后利用antsBrainExtraction.sh（ANTs）进行颅骨去除。颅骨去除是通过配准到模板实现的，可选用OASIS模板（默认）或NKI模板。通过人工目视检查，我们发现这种方法优于其他常用方法，这一结果也与此前的报道一致。当有多个T1w体积数据时，首先对其进行INU校正，然后采用mri_robust_template（FreeSurfer）将其融合为受试者的参考T1w图像。脑部表面结构通过受试者的参考T1w图像（及可选的T2加权图像）使用recon-all（FreeSurfer）进行重建。之前估算的脑掩膜会用一种基于Mindboggle引入的方法的定制变体进行细化，该方法用于融合由ANTs和FreeSurfer得到的皮层灰质（GM）分割结果。表面重建和随后的掩膜细化都是可选步骤，如果不需要进行表面分析，可以关闭以节省运行时间。空间标准化采用非线性配准，通过antsRegistration（ANTs）将数据配准到ICBM 152非线性不对称模板（2009c版本），这里使用的是去除颅骨后的参考T1w图像和标准模板。由于在体积分组层面重合度表现优异，ANTs被选为标准化工具。最后，利用fast（FSL）从参考、去除颅骨后的T1w图像中分割出脑组织，包括脑脊液（CSF）、白质（WM）和灰质（GM）。

功能性数据的预处理。对于数据集中每一个BOLD序列，首先会利用自研方法生成一个参考体积及其去除颅骨版本（详见在线方法部分“fMRIPrep的特殊处理步骤”）。然后，使用mcflirt（FSL）估算头部运动参数（包括每个体积到参考体积的变换矩阵，以及相应的旋转与平移参数）。在多种可选工具中（见表1），选择mcflirt的原因是其结果与其他工具相当，并且其输出的参数格式便于后续将空间变换组合为一步插值（见下文）。如果提供切片时间信息，则BOLD序列会（可选地）通过3dTshift（AFNI）进行切片时间校正。
当有场图（field map）信息时，或者请求“无场图校正”实验（详见fMRIPrep在神经影像学背景下的亮点），则使用相应方法进行磁敏感畸变校正（SDC）（参考在线方法及Figure S3）。之后，通过基于边界配准方法（boundary-based registration），用九自由度进行共配准到对应的T1w参考图像，以最小化剩余畸变。如启用表面重建，则fMRIPrep使用bbregister（FreeSurfer）；否则，应用FSL中的flirt实现的基于边界配准。根据我们的经验，bbregister因驱动注册过程的灰质/白质表面分辨率高、拓扑正确，因而效果更佳。

为支持各种输出空间（如BOLD序列的原始空间、T1w空间、FreeSurfer的fsaverage标准空间、空间标准化步骤使用的模板空间等），可以组合不同空间的变换。例如，为了生成模板空间（如MNI空间）下的预处理BOLD序列，可以串联以下变换：头动参数、磁敏感畸变逆变换（若已计算）、BOLD到T1w的配准、T1w到模板的配准。功能信号也会在进行表面重建时，利用mri_vol2surf（FreeSurfer）采样到对应的受试者脑表面。因此，这些采样表面可以利用在fMRIPrep流程中和recon-all内部空间映射所计算的变换，实现向各种输出空间的便捷转换。变换的组合允许使用antsApplyTransforms（ANTs）一次性插值重采样体积数据。为最小化线性或高斯核的平滑效应，采用Lanczos插值方法。

可选地，可以执行ICA-AROMA去噪处理，生成“非攻击性去噪”的序列。当启用ICA-AROMA时，时间序列先进行平滑，然后依据原始方法进行去噪。

干扰时间序列的提取。为了不将fMRIPrep的输出限定于某一特定分析类型，该工具默认不会进行任何时间域去噪处理。不过，它会为研究者提供多种混杂因素估算值，这些可以用于显式的干扰项回归，或作为高层次模型的一部分。这使得预处理与行为建模能够解耦，并有利于在不同去噪方案下评估最终结果的稳健性。
为实现基于成分的噪声校正（CompCor¹⁰），会提取一组生理噪声回归项。对于CompCor的两个变体——时间型（tCompCor）和解剖型（aCompCor），会在对BOLD时间序列进行高通滤波后（使用128秒截止的离散余弦滤波器），估算主成分。其中，六个tCompCor分量是根据在覆盖皮下区域的掩膜内前5%变化幅度最大的体素计算出来的。该皮下掩膜通过对脑掩膜进行强腐蚀获得，确保不会包含皮层灰质区。
对于aCompCor，会在上述掩膜与在T1w空间计算出的脑脊液（CSF）和白质（WM）区域掩膜的并集的交集内计算六个主成分，这些掩膜会投影到每个功能运行的本地空间（采用BOLD到T1w逆变换）。
逐帧位移（Framewise displacement⁴⁰）和DVARS会为每个功能序列计算，均采用Nipype中的实现（定义来源于Power等⁷）。
通过Nilearn¹⁶分别从脑脊液、白质和全脑掩膜中提取三个全局信号。
如果请求ICA-AROMA¹¹处理，则会收集“激进”噪声回归项并存放在相关的混杂因素文件中。由于ICA-AROMA的非激进清理是在其他干扰信号提取后进行的，因此激进回归项可用于使其他干扰项正交化，以避免在回归分析时重新引入噪声信号。此外，还会提供经“非激进”ICA-AROMA去噪后的数据版本，因为这种变体无法仅通过混杂因素回归实现。

可视化报告简化质量控制并最大化流程透明度

用户可以通过为每位参与者生成的个体报告来评估预处理的质量。图2展示了此类报告的示例，并描述了其结构。报告包含数据在预处理流程多个质量控制节点的动态图像和静态拼接图像。报告中的许多可视化元素，以及本文中的部分图表，均由Nilearn¹⁶生成。报告采用HTML格式，因此在任何平台上只需浏览器即可打开。这也使报告能轻松集成到在线神经影像服务（如OpenNeuro.org）中，并最大化了同事间的共享便捷性。这些报告极大地节省了评估结果质量所需的时间，同时通过可视化方式展示数据在整个流程中的完整来源，有助于理解处理流程的内部细节。
作为进一步提升透明度的措施，每份报告还配有一份引用模板（详见在线方法部分，Box S1），遵循Poldrack等人⁴¹提出的fMRI研究报告规范。该模板可用于撰写使用fMRIPrep的论文方法部分，详细说明处理流程，包括所有所用工具的软件版本，并对fMRIPrep中使用的每个工具及其作者给出致谢。

fMRIPrep在神经影像领域的亮点
fMRIPrep并不是首个用于fMRI数据预处理的流程。业界普遍使用的神经影像软件包都提供了相关流程，如afni_proc.py（AFNI）或feat（FSL）。其他备选方案包括C-PAC（用于连接组分析的可配置流程）、HCP Pipelines以及SPM的Batch Editor等。在本节中，我们将介绍fMRIPrep除稳健性和高质量之外的其他优点，这些特性使其有望成为科学家在fMRI预处理方面的优选工具。

分析方法无关性：fMRIPrep支持广泛的后续高级分析和建模方式。其他预处理流程通常会限定后续分析的方法，因为它们要求按特定方式分析预处理数据。与下游分析兼容性的重要限制，有时来源于输出数据的坐标空间，以及BOLD信号的采样方式（规则体积vs.不规则表面）。例如，HCP Pipelines支持表面空间分析，而C-PAC与feat则仅限体积空间。虽然afni_proc.py默认采用体积空间，但也可手动设定采样表面。fMRIPrep允许输出多种空间，包括个体空间和多种体积/表面分析用的标准图谱。相比之下，fMRIPrep有意避免引入限制后续分析的处理步骤（如空间平滑），而其他工具通常为了特定分析流程（如C-PAC用于静息态fMRI连接分析）设计专门的预处理步骤。

无场图磁敏畸变校正（SDC）：许多传统或当前的人类fMRI采集协议缺乏用于标准SDC的MR场图。fMRIPrep采用了Wang等人提出的“无场图”高分辨扩散EPI影像畸变校正方案，将同一受试者的T1w结构像作为无畸变目标，通过非线性配准实现校正。为了最大化EPI扫描（T2*）与T1w参考之间的对比度，先对T1w图像强度做反转。变形场的优化过程通过只允许沿相位编码（PE）方向的位移，并结合先验对变形幅度进行调节，实现了正则化。截止目前，没有其他流程将这种“无场图”SDC方法应用于BOLD图像。

完善的文档与社区驱动开发：与多数流程一样，fMRIPrep有详实的文档，但其极高的灵活性使得编写和维护文档变得更具挑战性。团队承诺，随着代码持续迭代，文档也将不断完善和更新。此外，fMRIPrep在开发过程中高度重视社区参与，主动接受研究者的建议和贡献，而其他部分软件通常采用较封闭的开发模式，仅通过邮件列表获取有限反馈。fMRIPrep的社区驱动开发模式能快速采用最新的fMRI预处理进展（例如，工具最初将STC置于HMC之前，但在用户建议后根据Power等人最新推荐[18]进行了调整），使用户群快速扩展，并吸收了大量第三方贡献（如支持无解剖信息的数据处理）。开源也让fMRIPrep得以频繁代码审核，有效提升软件质量和可靠性[44]。在线方法部分有关于社区互动、代码评审流程、以及模块化设计如何促进同行贡献的详细说明。最后，fMRIPrep实施了持续集成测试（详见Figure S5），而持续集成近年来被认为是保证计算科学分析复现性的关键措施[45,46]。

**图像2的解释**

这张图（Figure 2）展示的是fMRIPrep生成的可视化报告是如何帮助质量控制和理解预处理流程的。图像的左侧从上到下按流程阶段分为概览（Summary）、解剖处理（Anatomical processing）、场图处理（Fieldmaps processing）、功能处理（Functional processing）、错误（Errors），对应右侧详细解释了每个板块的具体内容和意义。

详细解读如下：

左侧流程说明
Summary（概览）
报告以数据集的总体情况作为起点，根据BIDS标准确定各项内容。

Anatomical processing（解剖处理）
这里展示了多个面板，用于检查解剖处理流程的质量，如脑组织分割、空间标准化、皮层表面重建（如有），这些结果通过一系列可视化图像面板进行展示。

Fieldmaps processing（场图处理）
数据集如果包含用于畸变校正的场图（fieldmap），报告会评估其与BOLD参考对齐与去畸变的效果，通过动态马赛克和曲线图可视化处理过程。

Functional processing（功能处理）
对每个BOLD序列在不同步骤和任务、会话中，报告会在不同质量控制节点展示动态图像。包括：

场图去畸变后的对齐效果；
原始BOLD空间下的大脑掩膜及CompCor噪声区（ROI）；
BOLD序列与T1w结构像之间的配准效果。
Errors（错误）
若处理过程中出现错误，fMRIPrep会明确报告所有问题，附上可折叠详细面板列出每个错误细节。

右侧关键图像说明
T1-weighted reference, brain mask, intensity inhomogeneity and brain tissue segmentation panel
通过静态拼图，可以检查预处理解剖图像中的四个关键步骤：T1加权图像参考、脑掩膜、强度不均匀性校正、脑组织分割。

Spatial normalization（空间标准化）
动态拼图，显示参考T1w图像配准到目标标准图谱的转换过程，便于检查配准的准确性。

Susceptibility distortion correction（磁敏感畸变校正）
如果有场图或者选择“无场图”校正方法，此处展示去畸变前后的对比马赛克（“before”和“after”），及白质轮廓作为解剖识别线索。

BOLD mask and CompCor ROIs（BOLD掩膜和CompCor噪声区）
展示最终BOLD信号的图像，轮廓表示脑掩膜以及CompCor混杂因素提取的两个噪声分析区ROI。

Alignment of BOLD and the T1w reference（BOLD与T1w参考的配准）
评估BOLD功能数据与结构数据的配准准确性，通过动态图像展现脑表面重建结果在BOLD参考下的叠加情况。

总结
这张图说明：

fMRIPrep报告不仅方便用户检查每一步预处理质量，还能直观展现数据流和结果，增强整个流程的透明度。
多面板、动态与静态拼图展示，让科研人员快速定位问题和理解每一步处理细节。
报告还包括错误明细，协助高效排查和改进。

